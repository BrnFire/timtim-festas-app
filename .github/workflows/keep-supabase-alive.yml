name: Keep Services Alive (Supabase & App)

on:
  schedule:
    - cron: "0 8 * * *"   # Rodar diariamente Ã s 05:00 BRT (UTC-3 => 08:00 UTC)
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Normalizar PROJECT_ID
        id: prep
        run: |
          PROJECT="${{ secrets.SUPABASE_PROJECT_ID }}"
          PROJECT="$(echo -n "$PROJECT" | tr -d '\r' | tr -d '\n' | xargs)"
          PROJECT="${PROJECT#https://}"
          PROJECT="${PROJECT#http://}"
          PROJECT="${PROJECT%.supabase.co}"
          PROJECT="${PROJECT%%/*}"

          echo "project_id=$PROJECT" >> "$GITHUB_OUTPUT"

      - name: Ping Supabase REST root
        run: |
          BASE="https://${{ steps.prep.outputs.project_id }}.supabase.co"
          echo "PING: $BASE/rest/v1/"
          curl -sS -I "$BASE/rest/v1/"

      - name: Ping tabela brinquedos
        run: |
          BASE="https://${{ steps.prep.outputs.project_id }}.supabase.co"
          echo "GET: $BASE/rest/v1/brinquedos?select=id&limit=1"
          curl -sS "$BASE/rest/v1/brinquedos?select=id&limit=1" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}"

      - name: Ping Streamlit app (opcional)
        if: ${{ env.APP_URL != '' }}
        env:
          APP_URL: ${{ secrets.APP_URL }}
        run: |
          echo "HEAD: $APP_URL"
          curl -sS -I "$APP_URL"
